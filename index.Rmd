---
title: "AGS Fake Door test Q1 26'"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: lumen
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(DT)
library(stringr)

# --- 1. DATA LOADING ---
df <- read_csv("ags_fake_door_db_raw.csv", show_col_types = FALSE)

# --- 2. DEFINICJE ETYKIET (TYLKO OFICJALNE ODPOWIEDZI) ---

labels_Q2_En <- c(
  "Lower international sales costs",
  "No legal/tax knowledge needed",
  "Reduced return risk",
  "Scalability outside base market",
  "Curiosity about new markets"
)

labels_Q3_En <- c(
  "Lack of knowledge",
  "No need to scale",
  "Fear of legal/tax requirements",
  "Profitability concerns",
  "Prefer not to say"
)

# --- 3. FUNKCJA DOPASOWUJĄCA (SKELETON MATCHING) ---
# Usuwa znaki specjalne, żeby dopasować odpowiedź do wzorca

get_skeleton <- function(x) {
  x %>%
    str_to_lower() %>%                 
    str_replace_all("[^a-ząćęłńóśźż]", "") 
}

# Wzorce Oficjalne (Polska Kafeteria)
skeletons_Q2 <- c(
  get_skeleton("Niższe koszty sprzedaży zagranicznej"),
  get_skeleton("Brak konieczności posiadania wiedzy prawno-podatkowej o eksporcie"),
  get_skeleton("Obniżone ryzyko zwrotów zamówień zagranicznych"),
  get_skeleton("Możliwość wyskalowania sprzedaży poza bazowy rynek"),
  get_skeleton("Ciekawość o nowych rynkach")
)

skeletons_Q3 <- c(
  get_skeleton("Nie mam wystarczającej wiedzy o sprzedaży zagranicznej"),
  get_skeleton("Nie potrzebuję skalować sprzedaży na innych rynkach"),
  get_skeleton("Obawiam się dodatkowych wymagań prawno-podatkowych"),
  get_skeleton("Obawiam się rentowności sprzedaży zagranicznej"),
  get_skeleton("Nie chcę podawać powodu")
)

# --- 4. PRZETWARZANIE DANYCH ---

# Translate Q1
df <- df %>%
  mutate(Q1 = case_when(
    Q1 == "Tak" ~ "Yes",
    Q1 == "Nie" ~ "No",
    TRUE ~ Q1
  ))

q1_data <- df %>% count(Q1)

# Główna funkcja przetwarzająca (BEZ klasyfikacji ręcznej)
process_data <- function(data, col_name, skeletons, labels, filter_val) {
  data %>%
    filter(Q1 == filter_val) %>%
    select(all_of(col_name)) %>%
    separate_rows(all_of(col_name), sep = "&") %>% 
    mutate(Response = !!sym(col_name)) %>%
    filter(!is.na(Response) & Response != "") %>%
    rowwise() %>%
    mutate(
      # Tworzymy "szkielet" z odpowiedzi użytkownika
      Response_Skeleton = get_skeleton(Response),
      
      # Sprawdzamy czy pasuje do oficjalnej listy
      Match_Index = match(Response_Skeleton, skeletons),
      
      # LOGIKA: Pasuje -> angielska nazwa. Nie pasuje -> Other.
      Category_En = ifelse(!is.na(Match_Index), 
                           labels[Match_Index], 
                           "Other (Manual entry)")
    ) %>%
    ungroup()
}

# Przetwarzanie Q2 i Q3
q2_processed <- process_data(df, "Q2", skeletons_Q2, labels_Q2_En, "Yes")
q3_processed <- process_data(df, "Q3", skeletons_Q3, labels_Q3_En, "No")

# Dane do wykresów
q2_chart_data <- q2_processed %>%
  count(Category_En) %>%
  mutate(Procent = n / sum(df$Q1 == "Yes")) %>% 
  arrange(desc(Procent))

q3_chart_data <- q3_processed %>%
  count(Category_En) %>%
  mutate(Procent = n / sum(df$Q1 == "No")) %>% 
  arrange(desc(Procent))

# Dane do tabeli (Tylko wpisy ręczne)
prepare_table <- function(data) {
  data %>%
    filter(Category_En == "Other (Manual entry)") %>% 
    count(Response, sort = TRUE) %>%
    rename(Original_Polish_Text = Response, Count = n)
}

q2_table <- prepare_table(q2_processed)
q3_table <- prepare_table(q3_processed)

# --- Q4 FUNNEL ---
total_respondents <- nrow(df)
interested <- sum(df$Q1 == "Yes")
leads <- df %>% filter(Q1 == "Yes", !is.na(Q4)) %>% nrow()
conversion_rate <- round(leads / interested * 100, 1)

```

## Row {data-height=150}

### Total Respondents

```{r}
valueBox(total_respondents, icon = "fa-users", color = "#bdc3c7")
```

### Interested (Yes)

```{r}
valueBox(interested, icon = "fa-thumbs-up", color = "#2ecc71")
```

### Leads Generated (Q4)

```{r}
valueBox(leads, icon = "fa-envelope", color = "#f39c12")
```

### Conversion Rate (Yes to Lead)

```{r}
valueBox(paste0(conversion_rate, "%"), icon = "fa-percent", color = "#e67e22")
```

## Row {data-height=400}

### AGS Interest Overview

```{r}
plot_ly(q1_data, labels = ~Q1, values = ~n, type = 'pie', hole = 0.5,
        textinfo = 'label+percent',
        textposition = 'outside', 
        textfont = list(color = '#000000', size = 14, family = "Arial, sans-serif"),
        marker = list(colors = c('#e74c3c', '#27ae60'))) %>% 
  layout(title = "Do you want to sell abroad with AGS?", 
         showlegend = TRUE)
```

### Conversion Funnel

```{r}
colors_funnel <- c("#bdc3c7", "#2ecc71", "#f39c12")

fig <- plot_ly(
  type = "funnel",
  y = c("All Respondents", "Interested (Q1 Yes)", "Left Contact (Q4)"),
  x = c(total_respondents, interested, leads),
  textinfo = "value+percent initial",
  marker = list(colors = colors_funnel)) 

fig <- fig %>% layout(title = "Funnel: Traffic to Lead")
fig
```

## Row {data-height=500}

### Q2: What brings the most value? (Target Group)

```{r}
plot_ly(q2_chart_data, x = ~Procent, y = ~reorder(Category_En, Procent), type = 'bar', orientation = 'h',
        marker = list(color = '#27ae60'),
        text = ~paste0("<b>", round(Procent*100, 1), "%</b>"), 
        textposition = 'outside',
        textfont = list(color = 'black', size = 12)) %>%
  layout(xaxis = list(
           tickformat = ".0%", 
           title = "% of Respondents", 
           range = c(0, 1.25)
         ),
         yaxis = list(title = ""),
         margin = list(l = 250, r = 50))
```

### "Other" Responses Analysis (Q2)

```{r}
datatable(q2_table, options = list(pageLength = 5, scrollY = "300px"), rownames = FALSE)
```

## Row {data-height=500}

### Q3: Why not? (Barriers)

```{r}
plot_ly(q3_chart_data, x = ~Procent, y = ~reorder(Category_En, Procent), type = 'bar', orientation = 'h',
        marker = list(color = '#c0392b'),
        text = ~paste0("<b>", round(Procent*100, 1), "%</b>"), 
        textposition = 'outside',
        textfont = list(color = 'black', size = 12)) %>%
  layout(xaxis = list(
           tickformat = ".0%", 
           title = "% of Respondents", 
           range = c(0, 1.25)
         ),
         yaxis = list(title = ""),
         margin = list(l = 250, r = 50))
```

### "Other" Responses Analysis (Q3)

```{r}
datatable(q3_table, options = list(pageLength = 5, scrollY = "300px"), rownames = FALSE)